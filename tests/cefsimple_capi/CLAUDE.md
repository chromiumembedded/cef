# CLAUDE.md - CEF Simple C API Example

This file provides guidance to Claude Code when working with the cefsimple_capi example application.

## Project Overview

**cefsimple_capi** is a minimal CEF browser application written in **pure C** (C11 standard) using the CEF C API. It demonstrates proper usage of CEF's C API including manual reference counting, handler callbacks, and cross-platform implementation.

This is a reference implementation showing how to use CEF from C without any C++ code.

## Essential Documentation

**ALWAYS read these documents when working on this project:**

1. **[cef_wiki/UsingTheCAPI.md](../../cef_wiki/UsingTheCAPI.md)** - Complete CEF C API guide
    - Base structure types (ref-counted vs scoped)
    - Reference counting rules and patterns
    - String handling
    - Thread safety and atomic operations
    - Complete working examples

2. **[cef/tools/claude/CLAUDE_BUILD_INSTRUCTIONS.md](../../tools/claude/CLAUDE_BUILD_INSTRUCTIONS.md)** - Build workflow and error fixing
    - Build system usage (GN and Ninja)
    - Fixing build errors during Chromium updates
    - Common error patterns and solutions

3. **[README.md](README.md)** - Project-specific documentation
    - Architecture and file organization
    - Key differences from C++ version
    - Critical C API rules specific to this implementation

**Note:** If the `cef_wiki` directory doesn't exist, create it by running from the `chromium/src` directory:
```bash
# Wiki content is now in docs/ directory
```

## Building

From the Chromium `src` directory:

```bash
# Debug build (x64)
autoninja -C out/Debug_GN_x64 cefsimple_capi

# Debug build (ARM64 on macOS)
autoninja -C out/Debug_GN_arm64 cefsimple_capi

# Release build
autoninja -C out/Release_GN_x64 cefsimple_capi

# Rebuild after fixing errors in a specific file
autoninja -C out/Debug_GN_x64 obj/cef/tests/cefsimple_capi/cefsimple_capi/simple_app.o
```

## Architecture and API Layers

Understanding the layering is critical when fixing build errors:

```
┌─────────────────────────────────────────┐
│  cefsimple_capi (this project)          │  ← We work here
│  - Pure C code (C11)                    │
│  - Uses CEF C API                       │
└─────────────────────────────────────────┘
                ↓ calls
┌─────────────────────────────────────────┐
│  CEF C API (cef/include/capi/*.h)       │  ← Auto-generated headers
│  - C wrappers around CEF C++ API        │  ← We reference these
│  - Generated by CEF translator tool     │
└─────────────────────────────────────────┘
                ↓ wraps
┌─────────────────────────────────────────┐
│  CEF C++ Implementation (cef/libcef/)   │  ← We don't modify
│  - C++ code wrapping Chromium           │
│  - Updated when Chromium updates        │
└─────────────────────────────────────────┘
                ↓ uses
┌─────────────────────────────────────────┐
│  Chromium (chrome/, content/, base/)    │  ← We don't modify
│  - Core browser engine                  │
│  - Updates cause cascading changes      │
└─────────────────────────────────────────┘
```

**Key points:**

- **We only modify** code in `cef/tests/cefsimple_capi/`
- **We consult** CEF C API headers in `cef/include/capi/` to understand the API
- When Chromium updates → CEF C++ updates → CEF C API updates → we update our C code

## File Organization

See [README.md](README.md) for complete architecture details. Key files:

### Utility Modules

- **ref_counted.h** - Reference counting macros (`IMPLEMENT_REFCOUNTING_SIMPLE`, `IMPLEMENT_REFCOUNTING_MANUAL`, `INIT_CEF_BASE_REFCOUNTED`)
- **simple_utils.h** - Common utilities (`CHECK` macro)
- **simple_browser_list.h/c** - Browser list with automatic reference counting

### Core Implementation

- **simple_app.h/c** - Application handler (`cef_app_t`)
- **simple_handler.h** - Client handler interface and structure definitions
- **simple_handler.c** - Main client handler, public API, browser close operations
- **simple_display_handler.c** - Display handler (title change)
- **simple_life_span_handler.c** - Life span handler (browser lifecycle)
- **simple_load_handler.c** - Load handler (error pages)
- **simple_views.h/c** - Browser view and window delegates

### Platform Entry Points

- **cefsimple_win.c** - Windows (wWinMain)
- **cefsimple_linux.c** - Linux (main)
- **cefsimple_mac.m** - macOS (NSApplicationMain integration)

### Platform Handlers

- **simple_handler_win.c** - Windows-specific (window title)
- **simple_handler_linux.c** - Linux-specific (X11 window title)
- **simple_handler_mac.m** - macOS-specific (NSWindow title)
- **process_helper_mac.c** - macOS helper process entry point

## Fixing Build Errors

**Important context:** This application uses the **CEF C API**, not Chromium APIs directly. When Chromium updates, CEF updates its C API wrappers to reflect changes in underlying Chromium functionality. This can cause build errors in our C code that need to be fixed.

#### What We're Working With

- **We modify:** Only files in `cef/tests/cefsimple_capi/` directory
- **We use:** CEF C API headers from `cef/include/capi/*.h`
- **We don't modify:** Chromium code, CEF implementation code, or patch files

#### When CEF C APIs Change

Similar to Chromium API updates, CEF C API changes follow patterns:

**Common CEF C API change patterns:**

1. **Function pointer signature changes** (new/removed parameters):
    ```c
    // Old CEF API
    void CEF_CALLBACK on_load_end(
        cef_load_handler_t* self,
        cef_browser_t* browser,
        cef_frame_t* frame,
        int httpStatusCode) { ... }

    // New CEF API (added is_main_frame parameter)
    void CEF_CALLBACK on_load_end(
        cef_load_handler_t* self,
        cef_browser_t* browser,
        cef_frame_t* frame,
        int httpStatusCode,
        int is_main_frame) { ... }
    ```

2. **Structure field changes** (renamed/removed members):
    ```c
    // Old
    window_info.window = parent_window;

    // New (if renamed)
    window_info.parent_window = parent_window;
    ```

3. **New required function pointers** in base structures:
    ```c
    // CEF added new function pointer to cef_base_ref_counted_t
    app->app.base.get_size = app_get_size;  // Must implement
    ```

4. **Handler callback changes** (different return types or parameters):
    ```c
    // Old - returned int
    int CEF_CALLBACK on_before_browse(...);

    // New - returns cef_return_value_t enum
    cef_return_value_t CEF_CALLBACK on_before_browse(...);
    ```

#### Fixing Process

1. **Read the error carefully** - Compiler tells you exactly what's wrong
2. **Check CEF C API headers** - Look at the current definition in `cef/include/capi/*.h`
3. **Update our code** - Modify files in `cef/tests/cefsimple_capi/` to match
4. **Rebuild incrementally** - Build individual .o files for fast feedback:
    ```bash
    autoninja -C out/Debug_GN_x64 obj/cef/tests/cefsimple_capi/cefsimple_capi/simple_handler.o
    ```
5. **Consult UsingTheCAPI.md** - Reference patterns for correct implementation

#### Example Fix Workflow

If you see this error:
```
simple_handler.c:45:3: error: too few arguments to function call
```

1. Read the full error to identify the function
2. Open the relevant CEF header (`cef/include/capi/cef_life_span_handler_capi.h`)
3. Compare the signature in the header with our code
4. Update our callback to match the new signature
5. Rebuild just that file to verify
6. If successful, continue to next error

See [CLAUDE_BUILD_INSTRUCTIONS.md](../../tools/claude/CLAUDE_BUILD_INSTRUCTIONS.md) for detailed workflow and common patterns. The same principles apply, but remember we're working with CEF C API changes, not Chromium API changes directly.

## Key Reminders

1. **We work with CEF C API** - Not Chromium APIs directly; consult `cef/include/capi/*.h` headers
2. **Only modify cefsimple_capi files** - Never change Chromium code, CEF implementation, or patches
3. **Always check documentation first** - UsingTheCAPI.md has complete reference implementations
4. **Reference counting is critical** - Use atomics, release parameters, add_ref returns
5. **API version must be initialized** - Call `cef_api_hash()` before any CEF functions
6. **Structure ordering matters** - CEF base structure MUST be first member
7. **Size field is CEF size** - Use `sizeof(cef_*_t)`, not `sizeof(your_wrapper_t)`
8. **Thread safety required** - Reference counting functions called from any thread
9. **When APIs change** - Check CEF C API headers first, then update our C code to match

## Testing

Run the application after building:

```bash
# macOS
out/Debug_GN_arm64/cefsimple_capi.app/Contents/MacOS/cefsimple_capi

# Linux
out/Debug_GN_x64/cefsimple_capi

# Windows
out/Debug_GN_x64/cefsimple_capi.exe
```

Expected behavior: Opens a window displaying https://www.google.com
